---
date: 2017-02-17T12:51:00+01:00
title: How to use jailbreakr
tags: [R]
menu:
  main:
    parent: Blog
    identifier: /blog/jailbreakr
    weight: 3
---

```{r, include=FALSE}
path_to_data <- "/home/cbrunos/Documents/blog/static/assets/Investment_total_factors_nace2.xlsx"
```

## What is `jailbreakr`

The `jailbreakr` package is probably one of the most interesting packages I came across recently.
This package makes it possible to extract messy data from spreadsheets. What is meant by messy? I
am sure you already had to deal with spreadsheets that contained little tables inside a single
sheet for example. As far as I know, there is no simple way of extracting these tables without having
to fiddle around a lot. This is now over with `jailbreakr`. Well not entirely, because `jailbreakr`
is still in development, but it works well already. If you want to know more about the planned
features, you can watch the
following
[video](https://channel9.msdn.com/Events/useR-international-R-User-conference/useR2016/jailbreakr-Get-out-of-Excel-free) by
Jenny Bryan, one of the package's authors.

## Installation and data

You will have to install the package from Github, as it is not on CRAN
yet. [Here is the Github link](https://github.com/rsheets/jailbreakr). To install the package, just
run the following commands in an R console:

```{r, eval = FALSE}
devtools::install_github(c("hadley/xml2",
                           "rsheets/linen",
                           "rsheets/cellranger",
                           "rsheets/rexcel",
                           "rsheets/jailbreakr"))
```

If you get the following error:

```
devtools::install_github("hadley/xml2")
Downloading GitHub repo hadley/xml2@master
from URL https://api.github.com/repos/hadley/xml2/zipball/master
Error in system(full, intern = quiet, ignore.stderr = quiet, ...) :
    error in running command
```
 and if you're on a GNU+Linux distribution try to run the following command:

```{r, eval = FALSE}
options(unzip = "internal")
```

and then run `github_install()` again.

As you can see, you need some other packages to make it work. Now we are going to get some data. We
are going to download some time series from the European Commission, data I had to deal with
recently. Download the data by clicking [here](http://ec.europa.eu/economy_finance/db_indicators/surveys/documents/series/nace2_ecfin_1701/investment_total_nsa_nace2.zip)
and look for the spreadsheet titled `Investment_total_factors_nace2.xlsx`. The data we are interested
in is on the second sheet, named `TOT`. You cannot import this sheet easily into R because there
are four tables on the same sheet. Let us use `jailbreakr` to get these tables out of the sheet and
into nice, tidy, data frames.

## `jailbreakr` to the rescue

The first step is to read the data in. For this, we are going to use the `rexcel` package, which is
also part of the `rsheets` organization on Github that was set up by Jenny Brian and Rich Fitzjohn,
the authors of these packages. `rexcel` imports the sheet you want but not in a way that is
immediately useful to you. It just gets the sheet into R, which makes it then possible to use
`jailbreakr`'s magic on it. First, let's import the packages we need:

```{r}
library("rexcel")
library("jailbreakr")
```

We need to check which sheet to import. There are two sheets, and we want to import the one called
`TOT`, the second one. But is it really the second one? I have noticed that sometimes, there are
hidden sheets which makes importing the one you want impossible. So first, let use use another
package, `readxl` and its function `excel_sheets()` to make sure we are extracting the sheet we
really need:

```{r}
sheets <- readxl::excel_sheets(path_to_data)

tot_sheet <- which(sheets == "TOT")

print(tot_sheet)
```
As you can see, the sheet we want is not the second, but the third! Let us import this sheet into R now
(this might take more time than you think; on my computer it takes around 10 seconds):

```{r, eval = FALSE}
my_sheet <- rexcel_read(path_to_data, sheet = tot_sheet)
```

```{r, include = FALSE, cache = TRUE}
my_sheet <- rexcel_read(path_to_data, sheet = tot_sheet)
```

Now we can start using `jailbreakr`. The function `split_sheet()` is the one that splits the sheet
into little tables:

```{r}
tables <- split_sheet(my_sheet)
str(tables)
```

`tables` is actually a list containing `worksheet_view` objects. Take a look at the `dim`
attribute: you see the dimensions of the tables there. When I started using `jailbreakr` I was
stuck here. I was looking for the function that would extract the data frames and could not find
it. Then I watched the video and I understood what I had to do: a `worksheet_view` object has a
`values()` method that does the extraction for you. This is a bit unusual in R (it made me feel
like I was using Python); maybe in future versions this `values()` method will become a separate
function of its own in the package. What happens when we use `values()`?

```{r}
library("purrr")
list_of_data <-  map(tables, (function(x)(x$values())))
map(list_of_data, head)
```

We are getting really close to something useful! Now we can get the first table and do some basic
cleaning to have a tidy dataset:

```{r}

dataset1 <- list_of_data[[1]]

dataset1 <- dataset1[-c(1:3), ]
dataset1[dataset1 == ":"] <- NA
colnames(dataset1) <- c("country", seq(from = 1991, to = 2017))

head(dataset1)
```

Et voilÃ ! We went from a messy spreadsheet to a tidy dataset in a matter of minutes. Even though
this package is still in early development and not all the features that are planned are available,
the basics are there and can save you a lot of pain!
